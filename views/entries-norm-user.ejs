<!DOCTYPE html>
<html lang="en">

<style>
  /* Style for the popup */
  .arkham-popup {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    padding: 20px;
    background-color: #fdfdff;
    /* Match with .bootstrap-tagsinput background-color */
    border: 2px solid #e4e6fc;
    /* Match with .bootstrap-tagsinput border-color */
    box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075);
    /* Match with .bootstrap-tagsinput box-shadow */
    border-radius: 4px;
    /* Match with .bootstrap-tagsinput border-radius */
    z-index: 9999;
    max-width: 100%;
    /* Match with .bootstrap-tagsinput max-width */
    cursor: text;
    /* Match with .bootstrap-tagsinput cursor */
  }

  /* Style for the close button */
  .arkham-popup .close {
    position: absolute;
    top: 5px;
    right: 5px;
    cursor: pointer;
  }
</style>


<head>
  <meta charset="UTF-8">
  <meta content="width=device-width, initial-scale=1, maximum-scale=1, shrink-to-fit=no" name="viewport">
  <title>Al Rahim Textile - Dashboard Login</title>
  <!-- General CSS Files -->
  <link rel="stylesheet" href="/css/app.min.css">
  <link rel="stylesheet" href="/bundles/bootstrap-social/bootstrap-social.css">
  <link rel="stylesheet" href="/bundles/select2/dist/css/select2.min.css">
  <link rel="stylesheet" href="/bundles/bootstrap-tagsinput/dist/bootstrap-tagsinput.css">
  <!-- Template CSS -->
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/components.css">

  <!-- Custom style CSS -->
  <link rel="stylesheet" href="css/custom.css">
  <link rel='shortcut icon' type='image/x-icon' href='img/favicon.ico' />


</head>

<body>
  <div class="loader"></div>
  <div id="app">
    <div class="main-wrapper main-wrapper-1">
      <div class="navbar-bg"></div>
      <nav class="navbar navbar-expand-lg main-navbar sticky">
        <div class="form-inline mr-auto">
          <ul class="navbar-nav mr-3">
            <li><a href="#" data-toggle="sidebar" class="nav-link nav-link-lg
									collapse-btn"> <i data-feather="align-justify"></i></a></li>
            <li><a href="#" class="nav-link nav-link-lg fullscreen-btn">
                <i data-feather="maximize"></i>
              </a></li>
            <li>
              
            </li>
          </ul>
        </div>
        <ul class="navbar-nav navbar-right">
          
          

          <!--Notifications-->


          <li class="dropdown"><a href="#" data-toggle="dropdown"
              class="nav-link dropdown-toggle nav-link-lg nav-link-user"> <img alt="image" src="img/user.png"
                class="user-img-radious-style"> <span class="d-sm-none d-lg-inline-block"></span></a>
            <div class="dropdown-menu dropdown-menu-right pullDown">
              <div class="dropdown-title">Welcome <%= userData.Designation %></div>
              <a  class="dropdown-item has-icon">Name : <%= userData.Name %>
              </a> <a  class="dropdown-item has-icon"> 
                Email:  <%= userData.Email %>
              </a> <a  class="dropdown-item has-icon"> 
                Contact:  <%= userData.Contact %>
              </a>
              <div class="dropdown-divider"></div>
              <a href="/logout" class="dropdown-item has-icon text-danger"> <i class="fas fa-sign-out-alt"></i>
                Logout
              </a>
            </div>
          </li>
        </ul>
      </nav>
    </div>
    <div class="main-sidebar sidebar-style-2">

      <aside id="sidebar-wrapper">

        <div class="sidebar-brand">

          <a href="/">
            <img alt="image" src="/img/al_rahim.jpg" class="header-logo" style="width: 70%; height: auto;" />
          </a>


        </div>

        <ul class="sidebar-menu">

          <li class="menu-header">Main</li>

          <% if(userData.Designation == "QA Team" || userData.Designation == "QMS Team" || userData.Designation == "Marketing Team" || userData.Designation == "Admin") { %>
          <li class="dropdown">
            <a href="/ccm-form1" class="nav-link"><i data-feather="monitor"></i><span>CCM Form</span></a>
          </li>
          <% } %>

          <li class="dropdown">
            <a href="/entries-norm-user" class="nav-link"><i data-feather="monitor"></i><span>Your Entries</span></a>
          </li>

          <% if(userData.Designation == "QA Team" || userData.Designation == "Admin") { %>
          <li class="dropdown">
            <a href="/entries-qa" class="nav-link"><i data-feather="monitor"></i><span>Review Entries for QA</span></a>
          </li>
          <% } %>

          <% if(userData.Designation == "QMS Team" || userData.Designation == "Admin") { %>
          <li class="dropdown">
            <a href="/entries-qms" class="nav-link"><i data-feather="monitor"></i><span>Review Entries for QMS</span></a>
          </li>
          <% } %>

          <% if(userData.Designation == "Admin") { %>

          <li class="dropdown">
            <a href="/" class="menu-toggle nav-link has-dropdown"><i data-feather="pie-chart"></i><span>Admin Actions</span></a>
            <ul class="dropdown-menu">
              <li><a class="nav-link" href="/users-list">Users List</a></li>
              <li><a class="nav-link" href="/products-list">Products List</a></li>
            </ul>

          </li>
          <% } %>

          <li class="dropdown">
            <a href="mailto:arkham.workmail@gmail.com"><i data-feather="mail"></i><span>Report Bug</span></a>
          </li>
          <!-- <li class="dropdown">
            <a href="/logout" class="nav-link"><i data-feather="log-out"></i><span>Logout</span></a>
          </li> -->



        </ul>
      </aside>
    </div>

    <section class="section">
      <div class="container mt-2">
        <div class="row">

          <div class="col-12 col-sm-8 offset-sm-1 col-md-6 offset-md-3 col-lg-6 offset-lg-3 col-xl-8 offset-xl-2">
            <div class="card" style="margin-top: 80px;">
              <div class="card-header d-flex justify-content-center">
                <h3>Entries List</h3>
              </div>
              <div class="card-body">
                <!-- <div class="float-right">
                  <form>
                    <div class="input-group">
                      <input type="text" class="form-control" placeholder="Search">
                      <div class="input-group-append">
                        <button class="btn btn-primary"><i class="fas fa-search"></i></button>
                      </div>
                    </div>
                  </form>
                </div> -->
                <div class="clearfix mb-3"></div>
                <div class="table-responsive">
                  <table class="table table-striped">
                    <tr>
                      <th>#</th>
                      <th>Author</th>
                      <th>Customer Name</th>
                      <th>Product</th>
                      <th>Created At</th>
                      <th>Status</th>
                      <th>QA Suggestions</th>
                      <th>Prod. Justification</th>
                    </tr>

                    <% for (let i=0; i < CCMFormDataReq.length; i++) { %>
                    <tr>
                      <td><%= CCMFormDataReq[i].id %></td>

                      <td>
                        <a href="#" onclick="showPopup('<%= CCMFormDataReq[i].Name %>', '<%= CCMFormDataReq[i].Designation %>', '<%= CCMFormDataReq[i].Email %>', '<%= CCMFormDataReq[i].Contact %>'); return false;">
                          <span><%= CCMFormDataReq[i].Name %></span>
                        </a>
                      </td>
                      <div id="userPopup" class="arkham-popup">
                        <span class="close" onclick="closePopup()">&times;</span>
                        <p><strong>Name:</strong> <span id="userName"></span></p>
                        <p><strong>Designation:</strong> <span id="userDesignation"></span></p>
                        <p><strong>Email:</strong> <span id="userEmail"></span></p>
                        <p><strong>Contact:</strong> <span id="userContact"></span></p>
                      </div>

                      <td><%= CCMFormDataReq[i].CustomerName %>
                        <div class="table-links">
                          <a href="/entry-details/<%= i + 1 %>">View</a>
                          <% if (CCMFormDataReq[i].ComplaintApprovedQA === false) { %>
                          <div class="bullet"></div>
                          <a href="/entry-details-edit/<%= i + 1 %>">Edit</a>
                          <% } %>
                        </div>
                      </td>

                      <td><%= CCMFormDataReq[i].Product %></td>
                      <!-- Custom date formatting -->
                      <td><%= new Date(CCMFormDataReq[i].ComplaintDate).toISOString().slice(0, 10) %></td>

                      <td>
                        <% if (CCMFormDataReq[i].ComplaintApprovedQA === null) { %>
                        <div class="badge badge-warning">Pending</div>
                        <% } else if (CCMFormDataReq[i].ComplaintApprovedQA === true) { %>
                        <div class="badge badge-success">Approved</div>
                        <div class="table-links">
                          <a href="#" class="accept-btn" data-entry-id="<%= CCMFormDataReq[i].id %>" data-toggle="modal" data-target="#viewCAPAModal">View CAPA</a>
                        </div>
                        <% } else { %>
                        <div class="badge badge-danger">Rejected</div>
                        <% } %>
                      </td>

                      <td>
                        <% if (CCMFormDataReq[i].ComplaintSuggestionQA === null) { %>
                        <div class="badge badge-warning">None</div>
                        <% } else { %>
                        <div class="badge badge-success">Provided</div>
                        <div class="table-links">
                          <a href="#" class="text-success" onclick="viewSuggestion('<%= CCMFormDataReq[i].ComplaintSuggestionQA %>')">View</a>
                        </div>
                        <% } %>
                      </td>

                      <td>
                        <% if (CCMFormDataReq[i].JustificationProd === null) { %>
                        <a href="#" class="btn btn-primary" onclick="showJustificationPopup()">Add Just.</a>
                        <% } else { %>
                        <a href="#" class="btn btn-primary" onclick="viewJustification('<%= CCMFormDataReq[i].JustificationProd %>')">View Just.</a>
                        <a href="#" class="btn btn-primary" onclick="removeJustification(<%= CCMFormDataReq[i].id %>)">Remove Just.</a>
                        <a href="#" class="btn btn-primary" onclick="showJustificationPopupEdit('<%= CCMFormDataReq[i].JustificationProd %>')">Edit Just.</a>
                        <% } %>

                      </td>

                      <div id="popup" class="arkham-popup">
                        <span class="close" onclick="closeJustificationPopup()">&times;</span>
                        <textarea id="popup-textarea" class="form-control"></textarea>
                        <button class="btn btn-primary btn-lg btn-block" onclick="saveAndCloseJustificationPopup('<%= CCMFormDataReq[i].id %>')">Save</button>
                      </div>


                    </tr>
                    <% } %>

                  </table>
                </div>
              </div>
            </div>

          </div>
        </div>

      </div>
    </section>

    <!-- viewCAPAModal -->
    <div class="modal fade" id="viewCAPAModal" tabindex="-1" role="dialog" aria-labelledby="viewCAPAModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="viewCAPAModalLabel">View CAPA Users</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label>Following are the CAPA users selected by the user</label>
              <select class="form-control select2" multiple style="width: 100%;" id="viewCAPAUsersSelect" disabled>
                <% for (let i=0; i < CCMUserDataReq.length; i++) { %>
                <option value="<%= CCMUserDataReq[i].Name %>"><%= CCMUserDataReq[i].Name %></option>
                <% } %>
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>



  </div>

  <!-- General JS Scripts -->
  <script src="/js/app.min.js"></script>
  <!-- JS Libraies -->
  <script src="/bundles/select2/dist/js/select2.full.min.js"></script>
  <script src="/bundles/bootstrap-tagsinput/dist/bootstrap-tagsinput.min.js"></script>
  <!-- Page Specific JS File -->
  <!-- Template JS File -->
  <script src="/js/scripts.js"></script>
  <!-- Custom JS File -->
  <script src="/js/custom.js"></script>
  <script src="/bundles/sweetalert/sweetalert.min.js"></script>
  <script src="/js/page/sweetalert.js"></script>

  <!-- View -->
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      const acceptButtons = document.querySelectorAll('.accept-btn');

      acceptButtons.forEach(function(button) {
        button.addEventListener('click', function(event) {
          event.preventDefault();

          const entryId = this.getAttribute('data-entry-id');

          // Fetch previously selected users for this entry
          fetch(`/getSelectedUsers?entryId=${entryId}`)
            .then(response => response.json())
            .then(data => {
              const selectedUsers = data.selectedUsers.split(','); // Split string into array

              // Set previously selected users as selected options
              $('#viewCAPAUsersSelect').val(selectedUsers);
              $('#viewCAPAUsersSelect').trigger('change');
            })
            .catch(error => {
              console.error('Error fetching selected users:', error);
            });
        });
      });
    });
  </script>

  <!-- Suggestion Scripts -->
  <script>
    // function viewSuggestion(suggestion) {
    //   alert("Suggestion: " + suggestion);
    // }

    // function showPopup(name, designation, email, contact) {
    //   document.getElementById("userName").innerText = name;
    //   document.getElementById("userDesignation").innerText = designation;
    //   document.getElementById("userEmail").innerText = email;
    //   document.getElementById("userContact").innerText = contact;
    //   document.getElementById("userPopup").style.display = "block";
    // }

    // function closePopup() {
    //   document.getElementById("userPopup").style.display = "none";
    // }
  </script>

  <script>
    // Function to show the popup
    function showJustificationPopup() {
      document.getElementById("popup").style.display = "block";
    }

    function showJustificationPopupEdit(justification) {
      document.getElementById("popup").style.display = "block";
      document.getElementById("popup-textarea").value = justification;
    }

    // Function to close the popup
    function closeJustificationPopup() {
      document.getElementById("popup").style.display = "none";
    }

    function saveAndCloseJustificationPopup(id) {
      var text = document.getElementById("popup-textarea").value;

      fetch(`/updateJustification?id=${id}&justification=${encodeURIComponent(text)}`, {
          method: 'POST'
        })
        .then(response => {
          if (response.ok) {
            window.location.reload();
          } else {
            console.error('Failed to update justification');
          }
        })
        .catch(error => {
          console.error('Error updating justification:', error);
        });

      // Close the popup
      closeJustificationPopup();
    }

    function removeJustification(id) {
      if (confirm("Are you sure you want to remove the Justification?")) {
        fetch(`/removeJustification?id=${id}`, {
            method: 'POST'
          })
          .then(response => {
            if (response.ok) {
              window.location.reload();
            } else {
              console.error('Failed to remove Justification');
            }
          })
          .catch(error => {
            console.error('Error removing Justification:', error);
          });
      }
    }

    function viewJustification(justification) {
      alert("Suggestion: " + justification);
    }

  </script>

</body>

</html>
